# 开发进度与功能清单

- 版本：v0.1
- 最近更新：2025-12-19

本文件用于持续记录“已完成/进行中/待实现”的功能与测试覆盖情况，作为交付过程的可追溯台账。

## 1. 已完成（✅）

### 1.1 后端（FastAPI）

- ✅ MetaDB（SQLite）落盘：`~/.docetl/_platform/platform.db`（受 `DOCETL_HOME_DIR` 影响）
- ✅ 启动初始化：自动创建表结构；支持通过环境变量引导创建平台管理员账号
- ✅ 认证（Auth）
  - `POST /auth/register`
  - `POST /auth/login`
  - `POST /auth/logout`
  - `GET /auth/me`
  - 支持 `Authorization: Bearer <token>` 或 Cookie（`docetl_session`）
- ✅ RBAC（鉴权与命名空间权限）
  - 已覆盖：`/pipelines`、`/fs/*`、`/should_optimize*`、`/ws/run_pipeline/{namespace}`
  - 读写规则：pipeline 与文件写入需要 `editor+`；读取需要 `viewer+`
  - 安全约束：`/fs/*` 仅允许访问 `~/.docetl/<namespace>/...`，禁止访问内部命名空间（如 `_platform`）
- ✅ 会话密钥持久化：未配置 `DOCETL_AUTH_SECRET` 时写入 `~/.docetl/_platform/auth_secret`，避免热重载后登录失效
- ✅ 平台管理员功能（Users）
  - `GET /users`（用户列表）
  - `POST /users`（创建用户）
  - `PATCH /users/{user_id}`（禁用/启用、设置 platform_role）
  - `POST /users/{user_id}/reset-password`
  - `PUT /users/{user_id}/namespaces/{namespace}`（设置 namespace 角色）
  - `GET /users/{user_id}/memberships`（查看授权）
- ✅ 审计日志（Audit）
  - `GET /audit-logs`（平台管理员可查）
  - 已覆盖：注册/登录/登出、用户创建/更新、授权变更等关键事件写入
- ✅ request_id：后端自动生成并回传 `x-request-id` 便于排查
- ✅ Runs（运行记录）
  - MetaDB：新增 `runs` 表（namespace/pipeline/状态/耗时/成本等）
  - API：`GET /runs`、`GET /runs/{run_id}`、`GET /runs/summary`、`POST /runs/{run_id}/cancel`
  - Pipeline 执行：HTTP/WS 自动写入 run 记录，返回 `run_id`，支持 WS 取消

### 1.2 前端（Next.js）

- ✅ 移除旧首页（DocETL Landing）：访问 `/` 直接重定向到 `/login`
- ✅ 新增登录与注册页：
  - `/login`：调用后端 `/auth/login`
  - `/register`：调用后端 `/auth/register`
- ✅ 登录态落本地：`localStorage` 保存 `token/expires_at/user`（后续会逐步用于 API 鉴权与页面守卫）
- ✅ 登录后自动设置默认 namespace：通过 `/auth/me` 读取 memberships 并写入 `docetl_namespace`
- ✅ 页面守卫：`/playground` 未登录或过期会跳转 `/login`
- ✅ 控制台布局：新增 `/console/*` 侧边栏与页面骨架（Dashboard/Execute/Deployments/Data Center/Settings）
- ✅ 登录/注册完成后跳转到 `/console/dashboard`
- ✅ Next API 代理转发鉴权：`/api/*` -> FastAPI 时会透传 `Authorization`/`cookie`（避免后端鉴权失效）
- ✅ 修复：切换 namespace 清理工作区时不会清除登录态（避免误登出）
- ✅ 文档预览鉴权：前端预览文件时附带 token，后端可正常鉴权读取

### 1.3 测试（Pytest）

- ✅ 新增后端测试：`tests/server/app/test_auth_rbac_audit.py`
  - 覆盖：注册/登录/登出/获取当前用户、平台管理员 RBAC（users/audit-logs）、审计日志写入
- ✅ 新增后端测试：`tests/server/app/test_runs_api.py`
  - 覆盖：runs 列表/summary、跨 namespace 权限校验、取消运行
- ✅ 新增后端测试：`tests/server/app/test_pipeline_fs_rbac.py`
  - 覆盖：pipelines RBAC、`/fs/read-file` 路径隔离、WebSocket token 与 namespace 权限校验

## 2. 进行中（🚧）

- 🚧 用户与权限 UI（前端控制台）
  - 用户列表/创建/禁用/重置密码、namespace 授权管理、审计日志查询页
- 🚧 Runs UI 与指标扩展（列表/详情/趋势/筛选/取消）
- 🚧 Deployments / Scheduler 的业务闭环开发（按 `01_技术设计文档.md` 推进）
- 🚧 Data Center 的业务闭环开发（按 `01_技术设计文档.md` 推进）

## 3. 待实现（🕒）

### 3.1 Runs（运行记录）+ 指标看板

- metrics：timeseries/breakdown
- Dashboard：趋势/TopN/最近运行列表与 drill-down
- Runs 详情：日志/产物链接、取消/重试与状态流转

### 3.2 数据中心（Data Center）

- datasets 元数据（MetaDB）+ 文件落盘（raw/normalized）
- 上传：JSON/CSV/Excel
- Excel：预览 + 配置（sheet/header/范围）+ 异步导入（大文件）
- 预览：分页读取/抽样
- 与执行页联动：选择输入数据集；执行输出登记为 generated dataset（含血缘）

### 3.3 部署（Deployments）+ 调度（Scheduler）

- deployments CRUD（MetaDB）
- Scheduler：持久化调度、misfire、重试、并发控制、幂等去重（deployment_id + scheduled_for）
- Deployments 页面：创建/启停/手动触发/下一次运行/最近运行

### 3.4 控制台 UI（Sidebar + 页面信息架构）

- 菜单可见性与权限联动（与 RBAC 一致）

## 4. 运行与验证

### 4.1 环境变量（最小集）

- `DOCETL_HOME_DIR`：后端可写目录（用于 MetaDB 与运行产物）
- `DOCETL_AUTH_SECRET`：会话 token 哈希密钥（生产必须配置）
- `DOCETL_BOOTSTRAP_ADMIN_USERNAME` / `DOCETL_BOOTSTRAP_ADMIN_PASSWORD`：引导创建平台管理员（生产建议只用于首次初始化）

### 4.2 测试命令

- 后端新增测试（推荐显式设置可写目录）：`DOCETL_HOME_DIR=$(pwd)/.tmp/docetl_home pytest -q tests/server/app`
