# 项目交付计划：平台（看板 / 执行 / 部署 / 数据中心）

- 版本：v0.1
- 日期：2025-12-18
- 交付方式：迭代交付（MVP -> Beta -> GA）

## 1. 目标与范围（交付口径）

### 1.1 v1（MVP/Beta）必须交付

- 控制台布局：左侧菜单 + 右侧内容区（看板/执行/部署/数据中心/设置）
- 用户与权限：用户注册/登录、用户管理、RBAC 权限控制、审计日志（登录与关键操作）
- 元数据数据库：引入 SQLite（默认，可配置 Postgres），承载用户/权限/审计/运行/调度/数据集登记/指标聚合
- 执行：可编辑并运行流水线，实时日志与结果展示
- 运行记录（Runs）：可查询历史、状态、耗时/成本等基础信息；支持手动与调度触发；支撑看板统计
- 看板指标：提供 summary + 趋势图 + TopN（指标不确定时先全量实现并支持开关/扩展）
- 数据中心：区分用户上传与流水线生成；支持 JSON/CSV/Excel（不固定规则）上传解析；支持预览配置与异步导入；支持在执行页选用
- 部署：可创建调度（cron/interval/once），支持启停与手动触发；具备持久化调度、misfire 补跑、失败重试、并发控制、幂等去重

### 1.2 v2（可选增强）

- 企业级身份：SSO（OIDC/SAML）、MFA、账号生命周期治理
- 权限增强：更细粒度 ABAC/资源级授权（pipeline/dataset 级别）、组织/团队模型
- 高可用与分布式：多实例 scheduler、worker/队列、弹性扩缩容、隔离执行环境
- 可观测性增强：告警通道、失败原因聚类、成本治理与配额、报表导出

## 2. 项目假设（影响排期的前提）

1) v1 必须提供本地账号体系（注册/登录）与 RBAC/审计；SSO/MFA 可后置到 v2
2) v1 引入 **元数据数据库**（默认 SQLite），文件系统用于保存大对象（输出/日志/上传文件）
3) v1 调度具备持久化与健壮性语义（misfire/重试/并发/幂等）；先单实例运行，v2 再做多实例高可用
4) LLM 调用密钥与运行环境由现有 `.env` 机制提供（v1 不做企业级密钥托管/配额体系）
5) Excel 解析规则不固定：v1 必须提供“预览 + 配置 + 异步导入”，并配置默认限额（超限提示/按范围导入）

> 若必须在 v1 同期上 SSO + Postgres + Worker/队列（或要求多实例 HA scheduler），排期需要相应上浮并重排架构。

## 3. 里程碑与交付物

| 里程碑 | 周期（建议） | 交付物 | 验收要点 |
|---|---:|---|---|
| M0 方案确认 | 0.5 周 | 需求澄清纪要 + 技术设计评审结论 | 关键未决问题有明确结论/延期策略 |
| M1 账号体系 + RBAC + 审计 | 1.5 周 | MetaDB + 注册/登录 + 用户管理 API + RBAC 校验 + 审计写入/查询 + 登录页/设置页基础 | 不同角色登录后可见内容受控；关键操作可在审计日志追溯 |
| M2 Runs + 指标看板 | 1.5 周 | Runs 模型/API + 执行链路写 run + metrics API（summary/timeseries/breakdown）+ Dashboard 页面 | 能跑通“执行->产生 run->看板统计/趋势图” |
| M3 数据中心（含 Excel 大文件） | 2 周 | Dataset registry/API + 上传 raw + 预览配置 + 异步导入 + 预览/下载 + 执行页数据集选择 | 不固定 Excel 可通过预览+配置导入；大文件不会阻塞请求线程；导入状态可见 |
| M4 部署调度（健壮性语义） | 2 周 | Deployments CRUD + Scheduler 持久化 + misfire/重试/并发/幂等去重 + Deployments 页面 | 定时触发稳定；重启后可恢复；不会重复创建同一 scheduled_for 的 run |
| M5 Beta 稳定性 | 1 周 | 测试补齐 + 文档 + Docker/部署验证 + 回归清单 | 回归通过、可演示、可上线试运行 |

> 周期按“2 前端 + 2 后端 + 0.5 QA（兼职）”估算；人力不足可通过减少范围（先做 interval/once、不做 cron 图表等）压缩。

## 4. WBS（工作拆分）

### 4.1 后端（FastAPI）

- Auth/RBAC/Audit
  - MetaDB：连接配置、迁移工具（如 Alembic）、基础表（users/roles/memberships/audit_logs）
  - 注册/登录/刷新：密码哈希、token 颁发与撤销、登录限流
  - RBAC：namespace 级鉴权中间件/依赖注入，覆盖 runs/deployments/datasets/pipelines
  - 审计：关键 API 自动写审计事件（含 request_id/ip/user_agent/before-after 摘要）
- Runs
  - runs 表与查询：分页、过滤（pipeline/deployment/status/user/time）
  - 执行链路改造：WebSocket 执行创建 run_id、状态流转、结束写回（含 log 落盘）
  - metrics：summary/timeseries/breakdown（按 status/pipeline/deployment/user/error 分组）
- Data Center
  - datasets 表：元数据、来源区分、血缘、ingest 状态
  - 上传：raw 落盘 + 预览（前 N 行）
  - 异步导入：Excel/CSV/JSON -> normalized（限额/错误/进度）
  - 预览：分页读取/抽样读取（必要时生成 preview 产物）
  - 生成数据登记：执行结束时登记 output 为 generated dataset
- Deployments
  - deployments 表：CRUD、唯一性约束（name）
  - Scheduler：持久化调度、next_run_at 计算、misfire、重试、并发限制、幂等去重（deployment_id + scheduled_for）
  - 操作接口：enable/disable、manual trigger、查看最近运行与下次运行
- 安全与稳健性
  - namespace 路径约束（防 path traversal）
  - 错误分级与可读错误信息
  - 日志落盘与清理策略（TTL）

### 4.2 前端（Next.js）

- 账号与权限
  - 登录/注册页（如支持自助注册；否则仅管理员创建账号）
  - 用户管理页（管理员）：用户列表、角色/namespace 授权、禁用/重置密码
  - 审计日志页：筛选、导出（按用户/动作/资源/时间）
- 控制台 Layout
  - Sidebar + Topbar（可选）+ 内容区路由
  - 菜单与路由：Dashboard / Execute / Deployments / Data Center / Settings
- Dashboard
  - 指标卡片、趋势图、TopN、最近运行列表（跳转到 run 详情）
- Execute
  - 复用 Playground：pipeline 管理、运行、结果展示
  - 输入选择：从数据中心选择 dataset（生成 YAML 的 input_path）
  - 输出登记：一键保存为 generated dataset（可选开关）
- Data Center
  - 数据集列表（来源筛选、搜索、标签）
  - 上传对话框：支持 Excel，提供预览与解析配置（sheet/header/范围），显示导入进度
  - 预览与下载：分页表格 + 下载原始/JSON（按实现）
- Deployments
  - 创建/编辑：schedule 表单（cron/interval/once）
  - 列表：状态、下一次运行时间、最近一次运行状态、重试/补跑策略概览

### 4.3 测试与质量

- 后端单测：DB 模型/鉴权/审计、解析、Scheduler 语义（尽量不依赖真实 LLM）
- 端到端冒烟脚本（可选）：上传数据集 -> 执行 -> runs 可见 -> 保存到数据中心
- 回归清单：核心路径、异常场景（解析失败、执行失败、取消、调度暂停）

## 5. 排期建议（按周）

> 可根据实际人力把“周”替换为“人日”，并按优先级裁剪。

### 第 1 周

- MetaDB 与迁移基建（SQLite 默认）
- Auth：注册/登录/刷新、密码哈希、基础安全策略
- RBAC：namespace 级鉴权中间件/依赖注入
- 控制台路由与布局骨架 + 登录页

### 第 2 周

- 用户管理与授权（管理员）+ 审计日志写入/查询 + 审计页
- Runs：执行链路写 run record、runs 列表/详情页（UI）
- Metrics：summary/timeseries/breakdown（后端）+ Dashboard 页面（基础版）

### 第 3 周

- Data Center：datasets 表/API、raw 上传、预览配置与 preview_only
- Excel 异步导入（含限额/错误处理）+ 预览分页
- 执行页支持从数据中心选择输入 + 输出登记为 generated dataset

### 第 4 周

- Deployments：CRUD + UI 表单
- Scheduler：持久化调度、misfire、重试、并发、幂等去重
- 调度触发执行并生成 run 记录（含 scheduled_for）

### 第 5 周

- 稳定性：日志落盘与清理、性能优化（metrics 聚合）、安全加固（限流/校验）
- 测试补齐与回归
- 文档与部署验证（docker / make run-ui）
- Beta 发布与验收

## 6. 资源与分工（建议）

- 产品/项目：需求澄清、验收标准、优先级裁剪
- 前端：控制台布局、页面实现（Dashboard/Execute/Deployments/Data Center）
- 后端：runs/deployments/data-center API + 存储 + scheduler
- QA（可兼职）：回归用例、关键路径验收、线上问题复现
- 运维（可兼职）：部署环境、日志采集、备份策略（若需要）

## 7. 风险清单与应对

| 风险 | 影响 | 应对策略 |
|---|---|---|
| SSO/MFA 被要求纳入 v1 | 架构与排期显著增加 | v1 先本地账号 + RBAC；若必须 SSO，优先 OIDC 并复用成熟组件 |
| Excel 超大文件解析性能/内存 | 后端 OOM、体验差 | 设限额；提供抽样预览；必要时做分片/流式解析 |
| 调度健壮性语义复杂 | 重复跑/漏跑/重试风暴 | DB 幂等去重（deployment_id + scheduled_for）；misfire/catchup 限额；退避重试；并发上限 |
| 执行与 API 同进程资源竞争 | API 响应慢、UI 卡顿 | 并发限制；长任务用线程池；v2 引入 worker |
| 指标“先全量实现”导致范围膨胀 | 排期失控 | 先落通用指标集与可扩展接口；UI 先做默认视图，复杂图表分批上线 |

## 8. 验收标准（建议）

### 8.0 用户与权限

- 支持注册/登录（或管理员创建账号）并可退出/刷新登录态
- 管理员可管理用户（创建/禁用/重置密码）并配置 namespace 角色
- RBAC 生效：不同角色看到的菜单与可执行操作不同，后端鉴权不允许越权
- 审计日志可查询：登录事件与关键操作（创建/更新/删除/执行/部署/上传）

### 8.1 看板

- 能展示 summary 指标 + 趋势图 + TopN（支持选择时间窗口或默认 24h）

### 8.2 执行

- 能创建/保存/切换 pipeline
- 能运行 pipeline，实时看到日志输出，结束后能看到结果（或错误）
- 能将本次输出登记为“生成数据集”，并在数据中心可见

### 8.3 数据中心

- 能上传 JSON/CSV/Excel，Excel 能解析为 JSON 并可预览
- 能区分“用户上传/流水线生成”，并可筛选
- 在执行页能选择某数据集作为输入（生成 YAML input_path）

### 8.4 部署

- 能创建部署（cron/interval/once），启用后可按计划触发执行
- 部署列表能看到下一次运行时间与最近一次运行状态
- 具备健壮性语义：重启可恢复；misfire 策略生效；失败重试与并发控制生效；同 scheduled_for 不重复创建 run

## 9. 上线与运维（v1 最小化）

- 发布前：完成 Beta 回归清单、准备演示数据与示例 pipeline
- 运行期：保留 run 日志与元数据（设置 TTL/清理策略），避免磁盘无限增长
- 备份：按 namespace 打包 `~/.docetl/<namespace>/...`（若需要）
