# 开发运行与部署

## 1. 本地开发（推荐路径）

### 1.1 Python 依赖（uv）

仓库提供 Make 目标（见 `Makefile`）：

- `make install`：安装 `uv`、同步依赖（含 dev 组与 extras）、并安装 pre-commit
- `make lint`：ruff（仅 `docetl/`）
- `make mypy`：mypy（仅 `docetl/`）

### 1.2 UI 依赖

- `make install-ui`：`website/` 下 `npm install`

### 1.3 启动（前后端一起）

- `make run-ui-dev`：
  - 后端：`uv run python server/app/main.py`
  - 前端：`npm run dev`（默认 `http://localhost:3000/playground`）

## 2. 环境变量与双 .env 设计

本仓库有两套 key/配置来源（不要混用）：

1) 根目录 `.env`（后端/执行引擎用）：参考 `.env.example`
   - 影响 FastAPI + DocETL pipeline 执行（LLM provider keys、CORS、端口等）

2) `website/.env.local`（前端 UI 用）：参考 `website/.env.local.example`
   - 影响 UI 助手功能（聊天、improve prompt 等）
   - 以及前端连后端的 host/port（`NEXT_PUBLIC_BACKEND_HOST/PORT`）

若要启用“UI 端 API Key 管理并加密传输”，需要同时在两侧配置相同的：

- `DOCETL_ENCRYPTION_KEY`（前端用于加密，后端/引擎用于解密；逻辑见 `website/src/app/api/utils.ts` 与 `docetl/utils.py`）

## 3. Docker / Compose

### 3.1 单容器（Makefile）

- `make docker`：build 并运行镜像，映射 3000/8000
- `make docker-clean`：删除 `docetl-data` volume（会清数据）

### 3.2 docker-compose

- `docker-compose.yml`：
  - 默认 host 端口映射可由环境变量覆写：
    - `FRONTEND_DOCKER_COMPOSE_PORT`（默认 3031 -> 容器 3000）
    - `BACKEND_DOCKER_COMPOSE_PORT`（默认 8081 -> 容器 8000）
  - 持久化卷：`docetl-data:/docetl-data`（容器内数据目录；具体使用取决于镜像实现）

## 4. 测试与快速验证

- `make tests-basic`：快速 smoke（注意：部分测试可能会实际调用 LLM，需配置 key）
- `make tests`：更完整的 pytest（默认跳过 ranking 与 `tests/test_ollama.py`）

如果只想验证单测：

- `uv run pytest -q tests/basic`

## 5. 文档站点（MkDocs）

- `make docs-serve`：启动 MkDocs，本地访问 `http://localhost:8001`
- 站点配置：`mkdocs.yml`，内容来源主要在 `docs/`
